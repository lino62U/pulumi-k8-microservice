name: CI/CD Pulumi a GKE

# Disparadores
on:
  pull_request:
    branches: [main]   # CI
  push:
    branches: [main]   # CD

# Jobs
jobs:

  # ==========================
  # JOB REUTILIZABLE: PREPARACIÃ“N DEL ENTORNO
  # ==========================
  setup-environment:
    name: Preparar entorno
    runs-on: ubuntu-latest
    outputs:
      python-path: ${{ steps.python.outputs.python-path }}
      gcloud-path: ${{ steps.gcloud.outputs.gcloud-path }}
    steps:
      - uses: actions/checkout@v4

      # Google Cloud Auth
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_JSON }}

      # Instalar Google Cloud SDK
      - name: Instalar Google Cloud SDK
        id: gcloud
        run: |
          curl -O https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-cli-linux-x86_64.tar.gz
          tar -xzf google-cloud-cli-linux-x86_64.tar.gz
          ./google-cloud-sdk/install.sh --quiet
          echo "${GITHUB_WORKSPACE}/google-cloud-sdk/bin" >> $GITHUB_PATH
          echo "gcloud-path=${GITHUB_WORKSPACE}/google-cloud-sdk/bin" >> $GITHUB_OUTPUT

      # Instalar plugin GKE Auth
      - name: Instalar plugin GKE auth
        run: |
          ${{ steps.gcloud.outputs.gcloud-path }}/gcloud components install gke-gcloud-auth-plugin --quiet
          echo "USE_GKE_GCLOUD_AUTH_PLUGIN=True" >> $GITHUB_ENV

      # Configurar Python y dependencias
      - name: Configurar Python
        id: python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
        run: |
          python -m pip install --upgrade pip
          pip install -r infra/requirements.txt
          echo "python-path=$(which python)" >> $GITHUB_OUTPUT

  # ==========================
  # JOB CI: PREVIEW DE PULUMI
  # ==========================
  pulumi-preview:
    name: CI - Pulumi Preview (PR)
    runs-on: ubuntu-latest
    needs: setup-environment
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      # Ejecutar preview de Pulumi
      - name: Pulumi Preview
        uses: pulumi/actions@v5
        with:
          command: preview
          stack-name: dev
          work-dir: infra
          comment-on-pr: true
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          GCP_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
          PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}

  # ==========================
  # JOB CD: DESPLIEGUE PULUMI
  # ==========================
  pulumi-deploy:
    name: CD - Pulumi Deploy (Main)
    runs-on: ubuntu-latest
    needs: setup-environment
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      # Ejecutar deploy de Pulumi
      - name: Pulumi Deploy
        uses: pulumi/actions@v5
        with:
          command: up
          args: --yes --skip-preview --refresh
          stack-name: dev
          work-dir: infra
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          GCP_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
          PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
